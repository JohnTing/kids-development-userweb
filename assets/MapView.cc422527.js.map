{"version":3,"file":"MapView.cc422527.js","sources":["../../src/components/HospitalMap.vue"],"sourcesContent":["<script setup lang=\"ts\">\r\nimport { computed } from \"@vue/reactivity\";\r\nimport { onMounted, ref, type Ref } from \"@vue/runtime-core\";\r\n\r\nimport Papa from 'papaparse'\r\n\r\n/*\r\nonMounted(() => {\r\n  let map = L.map(\"map\").setView([51.505, -0.09], 13);\r\n\r\n  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\r\n      maxZoom: 19,\r\n      attribution: '© OpenStreetMap'\r\n  }).addTo(map);\r\n})*/\r\n\r\ntype hospitalT = {\r\n  \"objectId\": string,\r\n  \"name\": string,\r\n  \"type\": number,\r\n  \"number\": number,\r\n  \"cap\": number,\r\n  \"updatedAt\"?: Date ,\r\n  \"createdAt\"?: Date\r\n}\r\n\r\n\r\ntype clinicT = {\r\n  name: string,\r\n  address: string,\r\n  telephone: string\r\n}\r\n\r\nconst queryString = window.location.search;\r\nconst urlParams = new URLSearchParams(queryString);\r\n\r\n\r\nconst hospitals: Ref<Record<string, hospitalT>> = ref({});\r\n\r\n// const citys: Ref<citysT> = ref({});\r\nconst type = ref(parseInt(urlParams.get(\"type\") + \"\"));\r\nconst clinic = ref(\"\");\r\n\r\n\r\nconst clinics: Ref<Array<clinicT>> = ref([]);\r\n\r\nconst hospitalurl = computed(() =>\r\n  \"https://maps.google.com/maps?q=\" + clinic.value + \"&t=&z=17&ie=UTF8&iwloc=&output=embed\"\r\n)\r\n\r\n/*\r\nfetch(\"administrativeArea.json\")\r\n  .then((value) => value.json())\r\n  .then((value) => {\r\n    citys.value = value;\r\n  });\r\n*/\r\n\r\nfetch(\"clinicList.csv\").then(value => value.text()).then(text => {\r\n  const data = Papa.parse(text).data as Array<string>;\r\n  for (let v of data) {\r\n    let c: clinicT = {\r\n      name: v[0],\r\n      address: v[1],\r\n      telephone: v[2]\r\n    }\r\n    clinics.value.push(c)\r\n  }\r\n});\r\n\r\n\r\nconst myHeaders = new Headers();\r\nmyHeaders.append(\"X-Parse-Application-Id\", \"kYUbkvUsiOYbHlfGTekGVCsdoLgHXglAcQbaO57f\");\r\nmyHeaders.append(\"X-Parse-REST-API-Key\", \"HBi7YTskQm6k7AcUFIN3Rp5sH2FMKvHbRyfEyr4Q\");\r\nmyHeaders.append(\"Content-Type\", \"application/json\");\r\n\r\nconst requestOptions = {\r\n  method: 'GET',\r\n  headers: myHeaders\r\n};\r\n\r\nfunction loadHospitalList() {\r\n\r\nfetch(\"https://kds.b4a.io/classes/HospitalList/\", requestOptions)\r\n  .then(response => response.json())\r\n  .then((value : {results:hospitalT[]}) => {\r\n\r\n    console.log(value.results)\r\n    hospitals.value = {}\r\n    value.results.map(v => {\r\n      if( v.type == type.value) {\r\n      delete v.createdAt;\r\n      delete v.updatedAt;\r\n      hospitals.value[v.name] = v;\r\n      }\r\n      });\r\n    })\r\n  .catch(error => console.log('error', error));\r\n}\r\nloadHospitalList();\r\n\r\n\r\nfunction submit(submitEvent: Event) {\r\n  submitEvent.preventDefault();\r\n  console.log(clinic.value)\r\n  if( !(clinic.value in hospitals.value)) {\r\n    \r\n    alert(\"不在選項內\");\r\n    return;\r\n  }\r\n  const theChooseOne = hospitals.value[clinic.value];\r\n\r\n  if( theChooseOne.number >= theChooseOne.cap) {\r\n    alert(\"已額滿\");\r\n    return;\r\n  }\r\n\r\n\r\n  // 模擬掛號\r\n  theChooseOne.number += 1\r\n\r\n  var raw = JSON.stringify(theChooseOne);\r\n  \r\n  const requestOptions = {\r\n    method: 'PUT',\r\n    headers: myHeaders, \r\n    body: raw\r\n  };\r\n  console.log(raw)\r\n  \r\n  fetch(\"https://kds.b4a.io/classes/HospitalList/\" + theChooseOne.objectId, requestOptions)\r\n  .then(response => response.json())\r\n  .then(value => {console.log(value); loadHospitalList(); })\r\n  .catch(error => console.log(error))\r\n\r\n  let namelist = Object.getOwnPropertyNames(hospitals.value);\r\n  namelist = namelist.filter(v => v != theChooseOne.name)\r\n  let thename = namelist[Math.floor(Math.random() * namelist.length)];\r\n  const notChooseOne = hospitals.value[thename]\r\n  notChooseOne.number -= 1;\r\n  const requestOptions2 = {\r\n    method: 'PUT',\r\n    headers: myHeaders, \r\n    body: JSON.stringify(notChooseOne)\r\n  };\r\n\r\n  fetch(\"https://kds.b4a.io/classes/HospitalList/\" + notChooseOne.objectId, requestOptions2)\r\n  .then(response => response.json())\r\n  .then(value => {console.log(value)})\r\n  .catch(error => console.log(error))\r\n\r\n}\r\n\r\n\r\n</script>\r\n\r\n<template>\r\n\r\n  <div class=\"form-row\">\r\n\r\n    <!--\r\n    <div class=\"col-sm-4\">\r\n      戶籍住址：\r\n      <select class=\"form-control\" id=\"city\" name=\"city\" v-model=\"city\" required>\r\n        <option v-for=\"(v, i) in citys\">{{ i }}</option>\r\n      </select>\r\n      <select class=\"form-control\" id=\"district\" name=\"district\" v-model=\"district\" required>\r\n        <option v-for=\"(v, i) in citys[city]\" :key=\"v\">{{ v }}</option>\r\n      </select>\r\n      <br>\r\n    </div>\r\n    -->\r\n\r\n    <div class=\"col-sm-8\">\r\n      <h2 v-if=\"type==0\">臺中市兒童發展聯合評估中心</h2>\r\n      <h2 v-if=\"type==1\">臺中市區域級以上醫療單位</h2>\r\n\r\n      <select class=\"form-control\" id=\"clinic\" name=\"clinic\" v-model=\"clinic\" required>\r\n        <option v-for=\"(v, i) in hospitals\" :key=\"v.name\"  :value=\"v.name\">{{ v.name + \" (\" + v.number + \"/\" + v.cap + \")\" }}</option>\r\n      </select>\r\n      <button type=\"submit\" class=\"btn btn-primary\" v-on:click=\"submit\">掛號</button>\r\n    </div>\r\n  </div>\r\n\r\n  <!-- \r\n  <select class=\"form-control\" id=\"selectHospital\" name=\"selectHospital\" v-on:change=\"onchange\" v-model=\"selected\">\r\n    <option v-for=\"(v, k, a) in hospitals\" :value=\"k\">{{ k }}</option>\r\n  </select>\r\n  -->\r\n\r\n  <div v-if=\"clinic\">\r\n  Google 地圖：\r\n  <iframe :src=\"hospitalurl\" width=\"100%\" height=\"480\" style=\"border:0;\" loading=\"lazy\"\r\n    referrerpolicy=\"no-referrer-when-downgrade\"></iframe>\r\n  </div>\r\n  \r\n</template>\r\n\r\n<style>\r\n#map {\r\n  height: 400px;\r\n}\r\n</style>\r\n"],"names":[],"mappings":"2YAiCM,KAAA,GAAc,OAAO,SAAS,OAC9B,EAAY,GAAI,iBAAgB,CAAW,EAG3C,EAA4C,EAAI,CAAA,CAAE,EAGlD,EAAO,EAAI,SAAS,EAAU,IAAI,MAAM,EAAI,EAAE,CAAC,EAC/C,EAAS,EAAI,EAAE,EAGf,EAA+B,EAAI,CAAA,CAAE,EAErC,EAAc,EAAS,IAC3B,kCAAoC,EAAO,MAAQ,sCACrD,EAUM,MAAA,gBAAgB,EAAE,KAAK,AAAA,GAAS,EAAM,MAAM,EAAE,KAAK,AAAQ,GAAA,CAC/D,KAAM,GAAO,EAAK,MAAM,CAAI,EAAE,KAC9B,OAAS,KAAK,GAAM,CAClB,GAAI,GAAa,CACf,KAAM,EAAE,GACR,QAAS,EAAE,GACX,UAAW,EAAE,EAAA,EAEP,EAAA,MAAM,KAAK,CAAC,CACtB,CAAA,CACD,EAGK,KAAA,GAAY,GAAI,SACZ,EAAA,OAAO,yBAA0B,0CAA0C,EAC3E,EAAA,OAAO,uBAAwB,0CAA0C,EACzE,EAAA,OAAO,eAAgB,kBAAkB,EAEnD,KAAM,GAAiB,CACrB,OAAQ,MACR,QAAS,CAAA,EAGiB,YAAA,CAEtB,MAAA,2CAA4C,CAAc,EAC7D,KAAK,AAAA,GAAY,EAAS,KAAM,CAAA,EAChC,KAAK,AAAC,GAAkC,CAE/B,QAAA,IAAI,EAAM,OAAO,EACzB,EAAU,MAAQ,GACZ,EAAA,QAAQ,IAAI,AAAK,GAAA,CACjB,AAAA,EAAE,MAAQ,EAAK,OACnB,OAAO,GAAE,UACT,MAAO,GAAE,UACC,EAAA,MAAM,EAAE,MAAQ,EAC1B,CACC,CAAA,CACF,EACF,MAAM,AAAA,GAAS,QAAQ,IAAI,QAAS,CAAK,CAAC,CAC7C,CACiB,IAGjB,WAAgB,EAAoB,CAGlC,GAFA,EAAY,eAAe,EACnB,QAAA,IAAI,EAAO,KAAK,EACpB,CAAE,GAAO,QAAS,GAAU,OAAQ,CAEtC,MAAM,gCAAO,EACb,MACF,CACM,KAAA,GAAe,EAAU,MAAM,EAAO,OAExC,GAAA,EAAa,QAAU,EAAa,IAAK,CAC3C,MAAM,oBAAK,EACX,MACF,CAIA,EAAa,QAAU,EAEnB,GAAA,GAAM,KAAK,UAAU,CAAY,EAErC,KAAM,GAAiB,CACrB,OAAQ,MACR,QAAS,EACT,KAAM,CAAA,EAER,QAAQ,IAAI,CAAG,EAEf,MAAM,2CAA6C,EAAa,SAAU,CAAc,EACvF,KAAK,AAAY,GAAA,EAAS,KAAK,CAAC,EAChC,KAAK,AAAS,GAAA,CAAC,QAAQ,IAAI,CAAK,EAAoB,GAAA,CAAI,EACxD,MAAM,GAAS,QAAQ,IAAI,CAAK,CAAC,EAElC,GAAI,GAAW,OAAO,oBAAoB,EAAU,KAAK,EACzD,EAAW,EAAS,OAAO,AAAK,GAAA,GAAK,EAAa,IAAI,EAClD,GAAA,GAAU,EAAS,KAAK,MAAM,KAAK,SAAW,EAAS,MAAM,GAC3D,KAAA,GAAe,EAAU,MAAM,GACrC,EAAa,QAAU,EACvB,KAAM,GAAkB,CACtB,OAAQ,MACR,QAAS,EACT,KAAM,KAAK,UAAU,CAAY,CAAA,EAGnC,MAAM,2CAA6C,EAAa,SAAU,CAAe,EACxF,KAAK,AAAY,GAAA,EAAS,KAAK,CAAC,EAChC,KAAK,AAAS,GAAA,CAAC,QAAQ,IAAI,CAAK,CAAA,CAAE,EAClC,MAAM,GAAS,QAAQ,IAAI,CAAK,CAAC,CAEpC"}